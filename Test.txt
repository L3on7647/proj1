Sub PowerPointgaPasportYaratis()
    Dim pptApp As Object
    Dim pptPres As Object
    Dim pptSlide As Object
    Dim pptShape As Object
    Dim excelSheet As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim pptPath As String
    Dim shablonSlideIndex As Integer
    
    ' --- SOZLAMALAR ---
    ' PowerPoint shabloningiz joylashgan to'liq manzilni shu yerga yozing:
    pptPath = "C:\Users\User\Desktop\Паспорт шаблон (002) (002).pptx" 
    
    ' Excel varaq nomi (Sizdagi rasmda "TABLE" deb yozilgan ekan)
    Set excelSheet = ThisWorkbook.Sheets("TABLE")
    shablonSlideIndex = 1 ' Nusxa olinadigan shablon slayd raqami
    ' ------------------

    ' Fayl borligini tekshirish
    If Dir(pptPath) = "" Then
        MsgBox "PowerPoint fayli topilmadi! Manzilni tekshiring.", vbCritical
        Exit Sub
    End If

    ' PowerPointni ochish
    On Error Resume Next
    Set pptApp = GetObject(, "PowerPoint.Application")
    If Err.Number <> 0 Then
        Set pptApp = CreateObject("PowerPoint.Application")
    End If
    On Error GoTo 0
    
    pptApp.Visible = True
    Set pptPres = pptApp.Presentations.Open(pptPath)

    ' Exceldagi oxirgi qatorni topish
    lastRow = excelSheet.Cells(excelSheet.Rows.Count, 1).End(xlUp).Row

    ' --- SIKL BOSHLANDI ---
    ' 2-qatordan boshlab oxirigacha aylanamiz
    For i = 2 To lastRow
        
        ' 1. Shablon slayddan nusxa olish
        pptPres.Slides(shablonSlideIndex).Duplicate
        
        ' 2. Yangi yaratilgan slayd bilan ishlash (u endi 2-raqamli bo'lib tushadi)
        ' Biz har doim nusxani shablonSlideIndex + 1 joyiga qo'shamiz
        Set pptSlide = pptPres.Slides(shablonSlideIndex + 1)
        
        ' 3. Ma'lumotlarni almashtirish (Find/Replace)
        ' Bu funksiya kirilchani buzmaydi, chunki o'zgaruvchilar to'g'ridan-to'g'ri
        ' Excel katagidan (Value) olinadi.
        
        Call TextAlmashtir(pptSlide, "{SAQLOVCHI}", excelSheet.Cells(i, 1).Value) ' A ustun
        Call TextAlmashtir(pptSlide, "{NOM}", excelSheet.Cells(i, 2).Value)       ' B ustun
        Call TextAlmashtir(pptSlide, "{MANZIL}", excelSheet.Cells(i, 3).Value)    ' C ustun
        Call TextAlmashtir(pptSlide, "{MAYDON}", excelSheet.Cells(i, 4).Value)    ' D ustun
        Call TextAlmashtir(pptSlide, "{TAVSIF}", excelSheet.Cells(i, 5).Value)    ' E ustun
        Call TextAlmashtir(pptSlide, "{KOM}", excelSheet.Cells(i, 6).Value)       ' F ustun
        Call TextAlmashtir(pptSlide, "{HOLAT}", excelSheet.Cells(i, 7).Value)     ' G ustun
        Call TextAlmashtir(pptSlide, "{SANA}", excelSheet.Cells(i, 8).Value)      ' H ustun
        Call TextAlmashtir(pptSlide, "{QIYMAT}", excelSheet.Cells(i, 9).Value)    ' I ustun
        Call TextAlmashtir(pptSlide, "{SHART}", excelSheet.Cells(i, 10).Value)    ' J ustun
        
        ' Slaydni oxiriga ko'chiramiz (tartib buzilmasligi uchun)
        pptSlide.MoveTo toPos:=pptPres.Slides.Count
        
    Next i

    MsgBox "Tayyor! " & (lastRow - 1) & " ta pasport yaratildi.", vbInformation

End Sub

' Yordamchi funksiya: Matnni almashtirish uchun
Sub TextAlmashtir(slide As Object, findText As String, replaceText As String)
    Dim shp As Object
    Dim txtRng As Object
    
    ' Agar katak bo'sh bo'lsa, xatolik bermasligi uchun
    If IsNull(replaceText) Then replaceText = ""
    
    For Each shp In slide.Shapes
        If shp.HasTextFrame Then
            If shp.TextFrame.HasText Then
                Set txtRng = shp.TextFrame.TextRange
                ' Katta-kichik harfga qaramay almashtiradi
                txtRng.Replace FindWhat:=findText, _
                               ReplaceWhat:=replaceText, _
                               WholeWords:=False
            End If
        End If
        
        ' Agar guruhlangan shakllar bo'lsa (Group)
        If shp.Type = 6 Then ' msoGroup
            Dim subShp As Object
            For Each subShp In shp.GroupItems
                If subShp.HasTextFrame Then
                    If subShp.TextFrame.HasText Then
                        subShp.TextFrame.TextRange.Replace FindWhat:=findText, _
                               ReplaceWhat:=replaceText, _
                               WholeWords:=False
                    End If
                End If
            Next subShp
        End If
    Next shp
End Sub
