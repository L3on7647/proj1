Sub PasportUniversal()
    Dim pptApp As Object
    Dim targetPres As Object, sourcePres As Object
    Dim pptSlide As Object
    Dim excelSheet As Worksheet
    Dim lastRow As Long, i As Long
    Dim targetPath As String, sourcePath As String
    Dim vinCode As String
    Dim isFound As String
    
    ' ================= SOZLAMALAR =================
    targetPath = "C:\Users\User\Desktop\Паспорт шаблон (002) (002).pptx"
    sourcePath = "C:\Users\User\Desktop\RASMLAR_BAZASI.pptx" 
    Set excelSheet = ThisWorkbook.Sheets("TABLE")
    ' ==============================================

    Application.ScreenUpdating = False
    
    On Error Resume Next
    Set pptApp = GetObject(, "PowerPoint.Application")
    If Err.Number <> 0 Then Set pptApp = CreateObject("PowerPoint.Application")
    On Error GoTo 0
    pptApp.Visible = True
    
    Set targetPres = pptApp.Presentations.Open(targetPath)
    Set sourcePres = pptApp.Presentations.Open(sourcePath)
    
    lastRow = excelSheet.Cells(excelSheet.Rows.Count, 1).End(xlUp).Row

    For i = 2 To lastRow
        DoEvents
        
        ' 1. Slayd yaratish
        targetPres.Slides(1).Duplicate
        Set pptSlide = targetPres.Slides(2)
        
        ' 2. Jadvalni to'ldirish
        Dim shp As Object, tbl As Object
        For Each shp In pptSlide.Shapes
            If shp.HasTable Then
                Set tbl = shp.Table
                tbl.Cell(1, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 1).Value
                tbl.Cell(2, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 2).Value
                tbl.Cell(3, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 3).Value
                tbl.Cell(4, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 4).Value
                tbl.Cell(5, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 5).Value
                tbl.Cell(6, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 6).Value
                tbl.Cell(7, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 7).Value
                tbl.Cell(8, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 8).Value
                tbl.Cell(9, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 9).Value
                tbl.Cell(10, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 10).Value
                Exit For
            End If
        Next shp
        
        ' 3. VIN kodni olish
        vinCode = Replace(Trim(excelSheet.Cells(i, 11).Value), " ", "")
        
        ' 4. Rasmlarni qidirish
        isFound = "VIN Topilmadi" ' Default holat
        If Len(vinCode) > 3 Then
            isFound = RasmlarniTop(sourcePres, pptSlide, vinCode)
        End If
        
        ' Natijani Excelga yozish
        excelSheet.Cells(i, 12).Value = isFound
        
        pptSlide.MoveTo toPos:=targetPres.Slides.Count
    Next i

    Application.ScreenUpdating = True
    MsgBox "Tayyor! L ustuniga qarang: Nima uchun rasm o'tmaganini yozib qo'ydim.", vbInformation
End Sub

' --- KUCHAYTIRILGAN QIDIRUV VA NUSXA OLISH ---
Function RasmlarniTop(sourcePres As Object, targetSlide As Object, cleanVin As String) As String
    Dim sld As Object
    Dim shp As Object
    Dim foundSlide As Object
    Dim picCount As Integer
    Dim newPic As Object
    Dim slideText As String
    Dim r As Long, c As Long
    
    ' O'lchamlar
    Dim imgWidth As Double: imgWidth = 255
    Dim imgHeight As Double: imgHeight = 194.5
    Dim startLeft As Double: startLeft = 360
    Dim startTop As Double: startTop = 80
    
    Set foundSlide = Nothing
    
    ' 1. VIN KOD BO'YICHA SLAYDNI TOPISH
    For Each sld In sourcePres.Slides
        For Each shp In sld.Shapes
            ' Matn ichidan qidirish
            If shp.HasTextFrame Then
                If shp.TextFrame.HasText Then
                    slideText = Replace(shp.TextFrame.TextRange.Text, " ", "")
                    If InStr(1, slideText, cleanVin, vbTextCompare) > 0 Then
                        Set foundSlide = sld
                        Exit For
                    End If
                End If
            End If
            ' Jadval ichidan qidirish
            If shp.HasTable Then
                For r = 1 To shp.Table.Rows.Count
                    For c = 1 To shp.Table.Columns.Count
                         If shp.Table.Cell(r, c).Shape.TextFrame.HasText Then
                            slideText = Replace(shp.Table.Cell(r, c).Shape.TextFrame.TextRange.Text, " ", "")
                            If InStr(1, slideText, cleanVin, vbTextCompare) > 0 Then
                                Set foundSlide = sld
                                Exit For
                            End If
                         End If
                    Next c
                Next r
            End If
        Next shp
        If Not foundSlide Is Nothing Then Exit For
    Next sld
    
    ' Agar slayd topilmasa
    If foundSlide Is Nothing Then
        RasmlarniTop = "VIN Topilmadi"
        Exit Function
    End If
    
    ' 2. SLAYD TOPILDI -> ENDI RASMLARNI KO'CHIRAMIZ
    picCount = 0
    RasmlarniTop = "Rasm Yo'q" ' Slayd bor, lekin rasm yo'q bo'lishi mumkin
    
    For Each shp In foundSlide.Shapes
        ' Jadvallarni o'tkazib yuboramiz
        If shp.HasTable Then GoTo KeyingiShakl
        
        ' Yozuvlarni o'tkazib yuboramiz (faqat rasm kerak)
        If shp.HasTextFrame Then
            If shp.TextFrame.HasText Then GoTo KeyingiShakl
        End If
        
        ' --- GURUHLAR (GROUP) BILAN ISHLASH ---
        If shp.Type = 6 Then ' msoGroup (Guruhlangan obyekt)
            Dim subShp As Object
            For Each subShp In shp.GroupItems
                ' Guruh ichidagi rasmni tekshiramiz
                If subShp.Type = 13 Or subShp.Type = 7 Then ' Picture or Embedded
                    Call CopyPasteImage(subShp, targetSlide, picCount, startLeft, startTop, imgWidth, imgHeight)
                    RasmlarniTop = "OK (Guruhdan)"
                    If picCount >= 4 Then Exit Function
                End If
            Next subShp
            GoTo KeyingiShakl
        End If

        ' --- ODDIY RASMLAR ---
        ' Type 13 = Picture, Type 7 = Embedded, Type 1 = AutoShape (bazan rasm bo'ladi)
        ' Type 14 = Placeholder (Picture Placeholder)
        Dim isPic As Boolean: isPic = False
        
        If shp.Type = 13 Or shp.Type = 7 Then isPic = True
        If shp.Type = 14 Then
            If shp.PlaceholderFormat.ContainedType = 18 Then isPic = True ' Picture Placeholder
        End If
        
        ' Agar shakl (Rectangle) bo'lsa-yu, ichida rasm bo'lsa (UserPicture)
        If shp.Type = 1 Then 
             ' Buni aniqlash qiyin, shuning uchun shunchaki copy qilib ko'ramiz
             ' lekin matni yo'qligiga ishonch hosil qilish kerak (tepada tekshirdik)
             isPic = True
        End If

        If isPic Then
            Call CopyPasteImage(shp, targetSlide, picCount, startLeft, startTop, imgWidth, imgHeight)
            RasmlarniTop = "OK"
            If picCount >= 4 Then Exit Function
        End If
        
KeyingiShakl:
    Next shp
End Function

' --- KO'CHIRISH VA JOYLASH UCHUN ALOHIDA SUB ---
Sub CopyPasteImage(shp As Object, targetSlide As Object, ByRef picCount As Integer, startLeft As Double, startTop As Double, w As Double, h As Double)
    Dim newPic As Object
    Dim retry As Integer
    
    shp.Copy
    DoEvents
    
    On Error Resume Next
    targetSlide.Shapes.Paste
    
    ' Agar xato bersa qayta urinish
    If Err.Number <> 0 Then
        Err.Clear
        For retry = 1 To 500
            DoEvents
            targetSlide.Shapes.Paste
            If Err.Number = 0 Then Exit For
        Next retry
    End If
    
    If Err.Number = 0 Then
        Set newPic = targetSlide.Shapes(targetSlide.Shapes.Count)
        With newPic
            .LockAspectRatio = msoFalse
            .Width = w
            .Height = h
            
            If (picCount Mod 2) = 0 Then
                .Left = startLeft
            Else
                .Left = startLeft + w + 5
            End If
            
            If picCount < 2 Then
                .Top = startTop
            Else
                .Top = startTop + h + 5
            End If
            
            ' Chiroyli ramka
            .Line.Visible = msoTrue
            .Line.Weight = 0.5
            .Line.ForeColor.RGB = RGB(0, 0, 0)
        End With
        picCount = picCount + 1
    End If
    On Error GoTo 0
End Sub
