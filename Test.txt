' --- ENG TEPAGA ---
#If VBA7 Then
    Private Declare PtrSafe Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
#Else
    Private Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
#End If
' ------------------

Sub PasportTezkor()
    Dim pptApp As Object
    Dim targetPres As Object, sourcePres As Object
    Dim pptSlide As Object
    Dim excelSheet As Worksheet
    Dim lastRow As Long, i As Long
    Dim targetPath As String, sourcePath As String
    Dim shp As Object, tbl As Object
    Dim vinCode As String
    Dim isFound As Boolean
    
    ' ================= SOZLAMALAR =================
    targetPath = "C:\Users\User\Desktop\Паспорт шаблон (002) (002).pptx"
    sourcePath = "C:\Users\User\Desktop\RASMLAR_BAZASI.pptx" 
    Set excelSheet = ThisWorkbook.Sheets("TABLE")
    ' ==============================================

    ' Ekranni yangilashni o'chiramiz (Tezlik uchun)
    Application.ScreenUpdating = False

    On Error Resume Next
    Set pptApp = GetObject(, "PowerPoint.Application")
    If Err.Number <> 0 Then Set pptApp = CreateObject("PowerPoint.Application")
    On Error GoTo 0
    pptApp.Visible = True
    
    Set targetPres = pptApp.Presentations.Open(targetPath)
    Set sourcePres = pptApp.Presentations.Open(sourcePath)
    
    lastRow = excelSheet.Cells(excelSheet.Rows.Count, 1).End(xlUp).Row

    For i = 2 To lastRow
        DoEvents ' Tizim qotib qolmasligi uchun minimal imkoniyat
        
        ' 1. Slayd yaratish
        targetPres.Slides(1).Duplicate
        Set pptSlide = targetPres.Slides(2)
        
        ' 2. Jadvalni to'ldirish
        For Each shp In pptSlide.Shapes
            If shp.HasTable Then
                Set tbl = shp.Table
                ' Ma'lumotlarni tez yozish
                tbl.Cell(1, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 1).Value
                tbl.Cell(2, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 2).Value
                tbl.Cell(3, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 3).Value
                tbl.Cell(4, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 4).Value
                tbl.Cell(5, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 5).Value
                tbl.Cell(6, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 6).Value
                tbl.Cell(7, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 7).Value
                tbl.Cell(8, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 8).Value
                tbl.Cell(9, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 9).Value
                tbl.Cell(10, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 10).Value
                Exit For ' Jadval topildimi? Bo'ldi, chiqib ketamiz (Vaqtni tejash)
            End If
        Next shp
        
        ' 3. VIN kodni tozalash
        vinCode = Replace(Trim(excelSheet.Cells(i, 11).Value), " ", "")
        
        ' 4. Rasmlarni qidirish
        isFound = False
        If Len(vinCode) > 3 Then
            isFound = RasmlarniTopVaJoyla(sourcePres, pptSlide, vinCode)
        End If
        
        ' Status yozish
        If isFound Then
            excelSheet.Cells(i, 12).Value = "OK"
        Else
            excelSheet.Cells(i, 12).Value = "Yo'q"
        End If
        
        pptSlide.MoveTo toPos:=targetPres.Slides.Count
    Next i

    Application.ScreenUpdating = True
    MsgBox "Tayyor! Tezlatilgan rejimda tugadi.", vbInformation
End Sub

' --- TEZKOR QIDIRUV FUNKSIYASI ---
Function RasmlarniTopVaJoyla(sourcePres As Object, targetSlide As Object, cleanVin As String) As Boolean
    Dim sld As Object
    Dim shp As Object
    Dim foundSlide As Object
    Dim picCount As Integer
    Dim newPic As Object
    Dim slideText As String
    Dim r As Long, c As Long
    
    ' O'lchamlar
    Dim imgWidth As Double: imgWidth = 255
    Dim imgHeight As Double: imgHeight = 194.5
    Dim startLeft As Double: startLeft = 360
    Dim startTop As Double: startTop = 80
    
    Set foundSlide = Nothing
    RasmlarniTopVaJoyla = False
    
    ' 1. SLAYDNI QIDIRISH
    For Each sld In sourcePres.Slides
        For Each shp In sld.Shapes
            
            ' A) Oddiy matn
            If shp.HasTextFrame Then
                If shp.TextFrame.HasText Then
                    ' Replace funksiyasi ozgina vaqt oladi, shuning uchun avval InStr bilan tekshiramiz
                    If InStr(1, shp.TextFrame.TextRange.Text, cleanVin, vbTextCompare) > 0 Then ' Probeli bilan bo'lsa ham topsin
                         Set foundSlide = sld
                         Exit For
                    Else ' Agar topilmasa, probelsiz variantni tekshiramiz
                        slideText = Replace(shp.TextFrame.TextRange.Text, " ", "")
                        If InStr(1, slideText, cleanVin, vbTextCompare) > 0 Then
                            Set foundSlide = sld
                            Exit For
                        End If
                    End If
                End If
            End If
            
            ' B) Jadval ichi
            If shp.HasTable Then
                ' Jadval ichini tekshirish sekin ishlashi mumkin, shuning uchun faqat kerak bo'lsa
                For r = 1 To shp.Table.Rows.Count
                    For c = 1 To shp.Table.Columns.Count
                         If shp.Table.Cell(r, c).Shape.TextFrame.HasText Then
                            If InStr(1, shp.Table.Cell(r, c).Shape.TextFrame.TextRange.Text, cleanVin, vbTextCompare) > 0 Then
                                Set foundSlide = sld
                                Exit For
                            End If
                         End If
                    Next c
                    If Not foundSlide Is Nothing Then Exit For
                Next r
            End If
        Next shp
        If Not foundSlide Is Nothing Then Exit For
    Next sld
    
    ' 2. RASMLARNI KO'CHIRISH (TEZKOR)
    If Not foundSlide Is Nothing Then
        RasmlarniTopVaJoyla = True
        picCount = 0
        
        For Each shp In foundSlide.Shapes
            ' JADVALNI ANIQLASH VA O'TKAZIB YUBORISH
            If shp.HasTable Then GoTo Keyingi
            If shp.HasTextFrame Then GoTo Keyingi
            
            ' Faqat Rasm turlarini ajratish
            Dim isPic As Boolean: isPic = False
            If shp.Type = 13 Then isPic = True
            If shp.Type = 14 Then
                If shp.PlaceholderFormat.ContainedType = 18 Then isPic = True
            End If

            If isPic Then
                shp.Copy
                ' Sleep vaqtini minimal qildim (faqat buferga tushish uchun yetarli)
                Sleep 50 
                
                On Error Resume Next
                targetSlide.Shapes.Paste
                
                If Err.Number = 0 Then
                    Set newPic = targetSlide.Shapes(targetSlide.Shapes.Count)
                    
                    With newPic
                        .LockAspectRatio = msoFalse
                        .Width = imgWidth
                        .Height = imgHeight
                        
                        If (picCount Mod 2) = 0 Then
                            .Left = startLeft
                        Else
                            .Left = startLeft + imgWidth + 5
                        End If
                        
                        If picCount < 2 Then
                            .Top = startTop
                        Else
                            .Top = startTop + imgHeight + 5
                        End If
                    End With
                    picCount = picCount + 1
                End If
                On Error GoTo 0
                
                If picCount >= 4 Then Exit For
            End If
Keyingi:
        Next shp
    End If
End Function
