Sub PowerPointgaPasportYaratis()
    Dim pptApp As Object
    Dim pptPres As Object
    Dim pptSlide As Object
    Dim excelSheet As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim pptPath As String
    Dim shablonSlideIndex As Integer
    
    ' --- SOZLAMALAR ---
    ' PowerPoint shabloningiz manzilini aniq kiriting:
    pptPath = "C:\Users\User\Desktop\Паспорт шаблон (002) (002).pptx" 
    
    ' Excel varaq nomi ("TABLE" ekanligiga ishonch hosil qiling)
    Set excelSheet = ThisWorkbook.Sheets("TABLE")
    shablonSlideIndex = 1
    ' ------------------

    If Dir(pptPath) = "" Then
        MsgBox "Fayl topilmadi! Manzilni tekshiring.", vbCritical
        Exit Sub
    End If

    On Error Resume Next
    Set pptApp = GetObject(, "PowerPoint.Application")
    If Err.Number <> 0 Then
        Set pptApp = CreateObject("PowerPoint.Application")
    End If
    On Error GoTo 0
    
    pptApp.Visible = True
    Set pptPres = pptApp.Presentations.Open(pptPath)

    lastRow = excelSheet.Cells(excelSheet.Rows.Count, 1).End(xlUp).Row

    ' --- ASOSIY SIKL ---
    For i = 2 To lastRow
        
        ' 1. Slayddan nusxa olish
        pptPres.Slides(shablonSlideIndex).Duplicate
        
        ' 2. Yangi slayd bilan ishlash
        Set pptSlide = pptPres.Slides(shablonSlideIndex + 1)
        
        ' 3. Ma'lumotlarni almashtirish (Jadval ichini ham qidiradi)
        Call TextAlmashtir(pptSlide, "{SAQLOVCHI}", excelSheet.Cells(i, 1).Value)
        Call TextAlmashtir(pptSlide, "{NOM}", excelSheet.Cells(i, 2).Value)
        Call TextAlmashtir(pptSlide, "{MANZIL}", excelSheet.Cells(i, 3).Value)
        Call TextAlmashtir(pptSlide, "{MAYDON}", excelSheet.Cells(i, 4).Value)
        Call TextAlmashtir(pptSlide, "{TAVSIF}", excelSheet.Cells(i, 5).Value)
        Call TextAlmashtir(pptSlide, "{KOM}", excelSheet.Cells(i, 6).Value)
        Call TextAlmashtir(pptSlide, "{HOLAT}", excelSheet.Cells(i, 7).Value)
        Call TextAlmashtir(pptSlide, "{SANA}", excelSheet.Cells(i, 8).Value)
        Call TextAlmashtir(pptSlide, "{QIYMAT}", excelSheet.Cells(i, 9).Value)
        Call TextAlmashtir(pptSlide, "{SHART}", excelSheet.Cells(i, 10).Value)
        
        ' Slaydni oxiriga ko'chirish
        pptSlide.MoveTo toPos:=pptPres.Slides.Count
        
    Next i

    MsgBox "Tayyor! " & (lastRow - 1) & " ta pasport to'ldirildi.", vbInformation

End Sub

' --- YANGILANGAN FUNKSIYA (Jadvallar uchun) ---
Sub TextAlmashtir(slide As Object, findText As String, replaceText As String)
    Dim shp As Object
    Dim txtRng As Object
    Dim r As Long, c As Long
    
    If IsNull(replaceText) Then replaceText = ""
    
    ' Slayddagi barcha shakllarni aylanamiz
    For Each shp In slide.Shapes
        
        ' 1-HOLAT: Agar bu oddiy yozuv bo'lsa
        If shp.HasTextFrame Then
            If shp.TextFrame.HasText Then
                shp.TextFrame.TextRange.Replace FindWhat:=findText, _
                               ReplaceWhat:=replaceText, WholeWords:=False
            End If
        End If
        
        ' 2-HOLAT: Agar bu JADVAL (Table) bo'lsa (Sizdagi holat shu!)
        If shp.HasTable Then
            For r = 1 To shp.Table.Rows.Count
                For c = 1 To shp.Table.Columns.Count
                    ' Har bir katak ichini tekshiramiz
                    If shp.Table.Cell(r, c).Shape.TextFrame.HasText Then
                        shp.Table.Cell(r, c).Shape.TextFrame.TextRange.Replace _
                            FindWhat:=findText, ReplaceWhat:=replaceText, WholeWords:=False
                    End If
                Next c
            Next r
        End If
        
        ' 3-HOLAT: Agar guruhlangan (Group) bo'lsa
        If shp.Type = 6 Then ' msoGroup
            Dim subShp As Object
            For Each subShp In shp.GroupItems
                If subShp.HasTextFrame Then
                    If subShp.TextFrame.HasText Then
                        subShp.TextFrame.TextRange.Replace FindWhat:=findText, _
                            ReplaceWhat:=replaceText, WholeWords:=False
                    End If
                End If
            Next subShp
        End If
        
    Next shp
End Sub
