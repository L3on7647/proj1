import os
import shutil
import pandas as pd
import win32com.client as win32
from pptx import Presentation
from pptx.enum.shapes import MSO_SHAPE_TYPE

# ================= SOZLAMALAR =================
BASE_DIR = r"C:\ShaxzodOtchet\Automatization"
DONOR_PATH = os.path.join(BASE_DIR, "JAMI.pptx")
SHABLON_PATH = os.path.join(BASE_DIR, "PASPORT2.pptx")
EXCEL_PATH = os.path.join(BASE_DIR, "table.xlsx")
TEMP_IMG_DIR = os.path.join(BASE_DIR, "TEMP_IMAGES")

# Rasm o'lchamlari (9x6.86 sm)
IMG_W = 255
IMG_H = 194.5
START_L = 360
START_T = 80

# ================= 1. KUCHAYTIRILGAN RASM OLISH (UNIVERSAL) =================
def extract_images_universal():
    print("1. Donor fayl tahlil qilinmoqda... (Biroz kuting)")
    
    if os.path.exists(TEMP_IMG_DIR):
        shutil.rmtree(TEMP_IMG_DIR)
    os.makedirs(TEMP_IMG_DIR)

    prs = Presentation(DONOR_PATH)
    total_images = 0
    
    for slide in prs.slides:
        vin_code = None
        
        # A) VIN KODNI QIDIRISH
        # 1. Matnlar ichidan
        for shape in slide.shapes:
            if shape.has_text_frame:
                text = shape.text_frame.text.replace(" ", "").strip()
                if len(text) > 5 and any(c.isdigit() for c in text) and len(text) < 25:
                    vin_code = text
                    break
            # 2. Jadval ichidan
            if shape.has_table:
                for row in shape.table.rows:
                    for cell in row.cells:
                        text = cell.text_frame.text.replace(" ", "").strip()
                        if len(text) > 5 and any(c.isdigit() for c in text) and len(text) < 25:
                            vin_code = text
                            break
                    if vin_code: break
            if vin_code: break
        
        # B) RASMLARNI SAQLASH
        if vin_code:
            save_path = os.path.join(TEMP_IMG_DIR, vin_code)
            if not os.path.exists(save_path):
                os.makedirs(save_path)
            
            img_count = 0
            
            # Yordamchi funksiya: Shakl ichidan rasm olish
            def save_shape_image(shp):
                nonlocal img_count
                try:
                    # 1. Oddiy Rasm (Picture)
                    if shp.shape_type == MSO_SHAPE_TYPE.PICTURE:
                        with open(os.path.join(save_path, f"{img_count}.jpg"), "wb") as f:
                            f.write(shp.image.blob)
                        img_count += 1
                    
                    # 2. Placeholder (Rasm joyi)
                    elif shp.shape_type == MSO_SHAPE_TYPE.PLACEHOLDER:
                        if hasattr(shp, "image"): # Agar ichida rasm bo'lsa
                            with open(os.path.join(save_path, f"{img_count}.jpg"), "wb") as f:
                                f.write(shp.image.blob)
                            img_count += 1
                            
                    # 3. Guruh (Group) - ichiga kiramiz
                    elif shp.shape_type == MSO_SHAPE_TYPE.GROUP:
                        for sub_shp in shp.shapes:
                            save_shape_image(sub_shp) # Rekursiya
                except:
                    pass

            # Slayddagi barcha shakllarni tekshiramiz
            for shape in slide.shapes:
                save_shape_image(shape)
            
            if img_count > 0:
                print(f"   + {vin_code}: {img_count} ta rasm topildi.")
                total_images += img_count
            else:
                print(f"   - {vin_code}: Papka ochildi, lekin rasm topilmadi (Format notanish)")

    print(f"--- JAMI {total_images} TA RASM SUG'URIB OLINDI ---")

# ================= 2. PASPORT YARATISH =================
def create_passports():
    print("\n2. Pasportlar yaratilmoqda...")
    
    # Excelni o'qish (Header=0 -> 1-qator sarlavha)
    try:
        df = pd.read_excel(EXCEL_PATH, header=0, usecols="A:K", dtype=str)
    except Exception as e:
        print(f"Excel xatosi: {e}")
        return

    ppt_app = win32.Dispatch("PowerPoint.Application")
    ppt_app.Visible = True
    pres = ppt_app.Presentations.Open(SHABLON_PATH)
    
    for index, row in df.iterrows():
        try:
            # Slayd yaratish
            pres.Slides(1).Duplicate()
            slide = pres.Slides(2) 
            
            # Ma'lumotlarni xavfsiz olish
            def get_val(idx):
                if idx < len(row):
                    val = str(row.iloc[idx])
                    if val.lower() in ["nan", "nat", "none"]: return ""
                    return val.strip()
                return ""

            val_a = get_val(0)
            val_b = get_val(1)
            val_c = get_val(2)
            val_d = get_val(3)
            val_e = get_val(4) # TAVSIF
            val_f = get_val(5)
            val_g = get_val(6)
            val_h = get_val(7)
            val_i = get_val(8)
            val_j = get_val(9)
            val_vin = get_val(10).replace(" ", "") # VIN (K)

            # Jadval va Matnlarni almashtirish
            for shp in slide.Shapes:
                if shp.HasTable:
                    tbl = shp.Table
                    try:
                        tbl.Cell(1, 2).Shape.TextFrame.TextRange.Text = val_a
                        tbl.Cell(2, 2).Shape.TextFrame.TextRange.Text = val_b
                        tbl.Cell(3, 2).Shape.TextFrame.TextRange.Text = val_c
                        tbl.Cell(4, 2).Shape.TextFrame.TextRange.Text = val_d
                        tbl.Cell(5, 2).Shape.TextFrame.TextRange.Text = val_e
                        tbl.Cell(6, 2).Shape.TextFrame.TextRange.Text = val_f
                        tbl.Cell(7, 2).Shape.TextFrame.TextRange.Text = val_g
                        tbl.Cell(8, 2).Shape.TextFrame.TextRange.Text = val_h
                        tbl.Cell(9, 2).Shape.TextFrame.TextRange.Text = val_i
                        tbl.Cell(10, 2).Shape.TextFrame.TextRange.Text = val_j
                    except: pass
                
                # {TAVSIF} ni almashtirish
                if shp.HasTextFrame:
                    if shp.TextFrame.HasText:
                        text = shp.TextFrame.TextRange.Text
                        if "{TAVSIF}" in text:
                            shp.TextFrame.TextRange.Replace("{TAVSIF}", val_e)
                        if "{TASNIF}" in text:
                            shp.TextFrame.TextRange.Replace("{TASNIF}", val_e)

            # --- RASMLARNI JOYLASH QISMI ---
            if val_vin:
                img_folder = os.path.join(TEMP_IMG_DIR, val_vin)
                
                # Diagnostika uchun print
                # print(f"Qidirilmoqda: {img_folder}")
                
                if os.path.exists(img_folder):
                    images = sorted(os.listdir(img_folder))
                    pic_count = 0
                    
                    if len(images) > 0:
                        for img_file in images:
                            if pic_count >= 4: break
                            full_path = os.path.join(img_folder, img_file)
                            
                            try:
                                new_pic = slide.Shapes.AddPicture(FileName=full_path, 
                                                                LinkToFile=False, 
                                                                SaveWithDocument=True, 
                                                                Left=0, Top=0, Width=IMG_W, Height=IMG_H)
                                # 2x2 Grid
                                new_pic.LockAspectRatio = 0
                                
                                if pic_count % 2 == 0: new_pic.Left = START_L
                                else: new_pic.Left = START_L + IMG_W + 5
                                    
                                if pic_count < 2: new_pic.Top = START_T
                                else: new_pic.Top = START_T + IMG_H + 5
                                
                                new_pic.Line.Visible = -1
                                new_pic.Line.Weight = 0.5
                                new_pic.Line.ForeColor.RGB = 0
                                pic_count += 1
                            except Exception as e:
                                print(f"Rasm qo'yishda xato ({val_vin}): {e}")
                    else:
                        print(f"DIQQAT: {val_vin} uchun papka bor, lekin ichi bo'sh!")
                else:
                    pass 
                    # print(f"Papka topilmadi: {val_vin}")

            slide.MoveTo(toPos=pres.Slides.Count)
            
        except Exception as e:
            print(f"Xatolik (Qator {index}): {e}")

    print("TAYYOR!")

# ISHGA TUSHIRISH
if __name__ == "__main__":
    extract_images_universal() # 1. Rasmlarni olish
    create_passports()         # 2. Pasport yasash
