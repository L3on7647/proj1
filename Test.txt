Sub JadvalniKochirish_Final()
    Dim shp As Shape
    Dim srcTable As Table
    Dim targetSlide As Slide
    Dim targetTable As Table
    Dim sel As Selection
    
    Dim clientName As String
    Dim carFullInfo As String
    Dim carName As String
    Dim balanceDate As String
    Dim balanceValue As String
    Dim lastCol As Integer
    
    ' 1. JADVALNI AQLLI TANLASH (Update)
    Set sel = ActiveWindow.Selection
    
    ' Agar hech narsa tanlanmagan bo'lsa
    If sel.Type = ppSelectionNone Then
        MsgBox "Iltimos, avval 1-rasmdagi JADVALNI ustiga bosing!", vbExclamation
        Exit Sub
    End If
    
    ' Agar matn yoki shakl tanlangan bo'lsa, uning Jadval ekanligini tekshiramiz
    On Error Resume Next
    If sel.Type = ppSelectionText Or sel.Type = ppSelectionShapes Then
        Set shp = sel.ShapeRange(1)
    Else
        MsgBox "Jadval tanlanmadi. Sichqoncha bilan jadval ustiga bosing.", vbCritical
        Exit Sub
    End If
    
    If shp.HasTable Then
        Set srcTable = shp.Table
    Else
        MsgBox "Siz tanlagan narsa jadval emas! Iltimos, aniq jadvalni tanlang.", vbCritical
        Exit Sub
    End If
    On Error GoTo 0

    ' 2. MA'LUMOTLARNI SUG'URIB OLISH
    lastCol = srcTable.Columns.Count
    
    ' A) MIJOZ NOMI (Qidiruv: 1-qatorning barcha kataklarini tekshiramiz)
    ' Ba'zan merged (birlashgan) bo'ladi, shuning uchun aniq katakni topish qiyin.
    ' Biz 1-qatordagi birinchi uchragan uzun matnni olamiz.
    clientName = GetCellText(srcTable, 1, 2) ' Odatda 2-ustunda bo'ladi
    If Len(clientName) < 3 Then clientName = GetCellText(srcTable, 1, 1)
    
    ' B) MASHINA HAQIDA (6-qator, oxirgi ustun)
    carFullInfo = GetCellText(srcTable, 6, lastCol)
    
    ' C) BALANS SANASI (7-qator)
    balanceDate = GetCellText(srcTable, 7, lastCol)
    
    ' D) BALANS QIYMATI (8-qator)
    balanceValue = GetCellText(srcTable, 8, lastCol)
    
    ' E) MULK NOMI (faqat birinchi qatorni ajratib olish)
    carName = SplitLine(carFullInfo, 0)

    ' 3. YANGI SLAYD YARATISH
    Set targetSlide = ActivePresentation.Slides.Add(ActiveWindow.View.Slide.SlideIndex + 1, ppLayoutBlank)
    
    ' Sarlavha
    Dim titleBox As Shape
    Set titleBox = targetSlide.Shapes.AddTextbox(msoTextOrientationHorizontal, 30, 20, 650, 40)
    With titleBox
        .Fill.ForeColor.RGB = RGB(141, 180, 226)
        .TextFrame.TextRange.Text = "OBYEKT PASPORTI"
        .TextFrame.TextRange.Font.Bold = msoTrue
        .TextFrame.TextRange.ParagraphFormat.Alignment = ppAlignCenter
        .TextFrame.VerticalAnchor = msoAnchorMiddle
        .TextFrame.TextRange.Font.Size = 20
        .TextFrame.TextRange.Font.Color.RGB = RGB(255, 255, 255)
    End With

    ' 4. YANGI JADVAL CHIZISH
    Set shp = targetSlide.Shapes.AddTable(8, 2, 30, 70, 450, 350)
    Set targetTable = shp.Table
    
    With targetTable
        .Columns(1).Width = 140
        .Columns(2).Width = 310
        
        FillRow targetTable, 1, "Balansda saqlovchi", clientName, True
        FillRow targetTable, 2, "Mulk nomi", carName
        FillRow targetTable, 3, "Manzili", ""
        FillRow targetTable, 4, "Maydoni", ""
        FillRow targetTable, 5, "Tavsifi", carFullInfo
        targetTable.Cell(5, 2).Shape.TextFrame.TextRange.Font.Size = 10
        
        FillRow targetTable, 6, "Holati", "Qoniqarli"
        FillRow targetTable, 7, "Balansga olingan sana", balanceDate
        FillRow targetTable, 8, "Balans qiymati", balanceValue
        
        .ApplyStyle "{5C22544A-7EE6-4342-B048-85BDC9FD1C3A}"
    End With
    
    MsgBox "Tayyor! Yangi slayd yaratildi.", vbInformation
End Sub

' --- YORDAMCHI FUNKSIYALAR ---

Function GetCellText(tbl As Table, r As Integer, c As Integer) As String
    On Error Resume Next
    Dim txt As String
    txt = tbl.Cell(r, c).Shape.TextFrame.TextRange.Text
    txt = Replace(txt, Chr(13), vbCr)
    txt = Replace(txt, Chr(7), "")
    GetCellText = Trim(txt)
End Function

Function SplitLine(txt As String, index As Integer) As String
    Dim arr() As String
    If InStr(txt, vbCr) > 0 Then
        arr = Split(txt, vbCr)
    Else
        arr = Split(txt, " ")
    End If
    
    If UBound(arr) >= index Then
        SplitLine = arr(index)
    Else
        SplitLine = txt
    End If
End Function

Sub FillRow(tbl As Table, r As Integer, header As String, val As String, Optional isBold As Boolean = False)
    tbl.Cell(r, 1).Shape.TextFrame.TextRange.Text = header
    tbl.Cell(r, 2).Shape.TextFrame.TextRange.Text = val
    If isBold Then tbl.Cell(r, 2).Shape.TextFrame.TextRange.Font.Bold = msoTrue
End Sub
