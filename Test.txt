' --- ENG TEPAGA ---
#If VBA7 Then
    Private Declare PtrSafe Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
#Else
    Private Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
#End If
' ------------------

Sub PasportUniversalRasmli()
    Dim pptApp As Object
    Dim targetPres As Object, sourcePres As Object
    Dim pptSlide As Object
    Dim excelSheet As Worksheet
    Dim lastRow As Long, i As Long
    Dim targetPath As String, sourcePath As String
    Dim shp As Object, tbl As Object
    Dim vinCode As String
    Dim isFound As Boolean
    
    ' ================= SOZLAMALAR =================
    targetPath = "C:\Users\User\Desktop\Паспорт шаблон (002) (002).pptx"
    sourcePath = "C:\Users\User\Desktop\RASMLAR_BAZASI.pptx" 
    Set excelSheet = ThisWorkbook.Sheets("TABLE")
    ' ==============================================

    On Error Resume Next
    Set pptApp = GetObject(, "PowerPoint.Application")
    If Err.Number <> 0 Then Set pptApp = CreateObject("PowerPoint.Application")
    On Error GoTo 0
    pptApp.Visible = True
    
    Set targetPres = pptApp.Presentations.Open(targetPath)
    Set sourcePres = pptApp.Presentations.Open(sourcePath)
    
    lastRow = excelSheet.Cells(excelSheet.Rows.Count, 1).End(xlUp).Row

    For i = 2 To lastRow
        DoEvents: Sleep 100
        
        ' 1. Slayd yaratish
        targetPres.Slides(1).Duplicate
        Set pptSlide = targetPres.Slides(2)
        
        ' 2. Jadvalni to'ldirish
        For Each shp In pptSlide.Shapes
            If shp.HasTable Then
                Set tbl = shp.Table
                tbl.Cell(1, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 1).Value
                tbl.Cell(2, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 2).Value
                tbl.Cell(3, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 3).Value
                tbl.Cell(4, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 4).Value
                tbl.Cell(5, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 5).Value
                tbl.Cell(6, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 6).Value
                tbl.Cell(7, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 7).Value
                tbl.Cell(8, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 8).Value
                tbl.Cell(9, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 9).Value
                tbl.Cell(10, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 10).Value
            End If
        Next shp
        
        ' 3. VIN kodni tozalash
        vinCode = Replace(Trim(excelSheet.Cells(i, 11).Value), " ", "")
        
        ' 4. Rasmlarni qidirish
        isFound = False
        If Len(vinCode) > 3 Then
            isFound = RasmlarniTopVaJoyla(sourcePres, pptSlide, vinCode)
        End If
        
        ' Agar rasm topilmasa, Excelga yozib qo'yadi
        If isFound = False Then
            excelSheet.Cells(i, 12).Value = "Rasm Topilmadi"
        Else
            excelSheet.Cells(i, 12).Value = "OK"
        End If
        
        pptSlide.MoveTo toPos:=targetPres.Slides.Count
    Next i

    MsgBox "Tugadi! Exceldagi L ustuniga qarang, qaysi biri o'tmagan bo'lsa yozildi.", vbInformation
End Sub

' --- KUCHAYTIRILGAN QIDIRUV FUNKSIYASI ---
Function RasmlarniTopVaJoyla(sourcePres As Object, targetSlide As Object, cleanVin As String) As Boolean
    Dim sld As Object
    Dim shp As Object
    Dim foundSlide As Object
    Dim picCount As Integer
    Dim newPic As Object
    Dim slideText As String
    Dim r As Long, c As Long
    
    ' O'lchamlar (9x6.86 sm)
    Dim imgWidth As Double: imgWidth = 255
    Dim imgHeight As Double: imgHeight = 194.5
    Dim startLeft As Double: startLeft = 360
    Dim startTop As Double: startTop = 80
    
    Set foundSlide = Nothing
    RasmlarniTopVaJoyla = False ' Boshlanishida topilmadi deb turamiz
    
    ' 1. SLAYDNI QIDIRISH
    For Each sld In sourcePres.Slides
        ' Oddiy matnlarni tekshirish
        For Each shp In sld.Shapes
            If shp.HasTextFrame Then
                If shp.TextFrame.HasText Then
                    slideText = Replace(shp.TextFrame.TextRange.Text, " ", "")
                    If InStr(1, slideText, cleanVin, vbTextCompare) > 0 Then
                        Set foundSlide = sld
                        Exit For
                    End If
                End If
            End If
            ' Jadval ichini tekshirish
            If shp.HasTable Then
                For r = 1 To shp.Table.Rows.Count
                    For c = 1 To shp.Table.Columns.Count
                         If shp.Table.Cell(r, c).Shape.TextFrame.HasText Then
                            slideText = Replace(shp.Table.Cell(r, c).Shape.TextFrame.TextRange.Text, " ", "")
                            If InStr(1, slideText, cleanVin, vbTextCompare) > 0 Then
                                Set foundSlide = sld
                                Exit For
                            End If
                         End If
                    Next c
                Next r
            End If
        Next shp
        If Not foundSlide Is Nothing Then Exit For
    Next sld
    
    ' 2. RASMLARNI KO'CHIRISH
    If Not foundSlide Is Nothing Then
        RasmlarniTopVaJoyla = True ' Slayd topildi!
        picCount = 0
        
        For Each shp In foundSlide.Shapes
            ' DIQQAT: Bu yerda faqat "Rasm" emas, barcha shubhali obyektlarni olamiz
            ' Type 13 = Picture
            ' Type 14 = Placeholder (Ko'pincha rasm shuning ichida bo'ladi)
            ' Type 7 = Embedded Object
            ' Type 6 = Group (Agar rasmlar gruppalangan bo'lsa)
            
            Dim isTargetImage As Boolean
            isTargetImage = False
            
            ' Agar shakl ichida matn bo'lmasa, uni rasm deb taxmin qilamiz
            If Not shp.HasTextFrame Then
                isTargetImage = True
            Else
                If Not shp.TextFrame.HasText Then isTargetImage = True
            End If
            
            ' Yoki aniq turlarini tekshiramiz
            If shp.Type = 13 Or shp.Type = 14 Or shp.Type = 7 Or shp.Type = 6 Then
                isTargetImage = True
            End If
            
            ' Sarlavha yoki Slide Numberlarni ko'chirmaslik uchun
            If shp.Type = 14 Then ' Placeholder bo'lsa
                If shp.PlaceholderFormat.Type = 1 Or shp.PlaceholderFormat.Type = 3 Then ' Title / Slide Text
                    isTargetImage = False
                End If
            End If
            
            ' --- NUSXA OLISH ---
            If isTargetImage Then
                shp.Copy
                DoEvents
                Sleep 400 ' Kutish vaqtini oshirdim
                
                On Error Resume Next ' Xatolik bo'lsa o'tib ketsin
                targetSlide.Shapes.Paste
                
                If Err.Number = 0 Then
                    Set newPic = targetSlide.Shapes(targetSlide.Shapes.Count)
                    
                    ' Formatlash
                    With newPic
                        .LockAspectRatio = msoFalse
                        .Width = imgWidth
                        .Height = imgHeight
                        
                        If (picCount Mod 2) = 0 Then
                            .Left = startLeft
                        Else
                            .Left = startLeft + imgWidth + 5
                        End If
                        
                        If picCount < 2 Then
                            .Top = startTop
                        Else
                            .Top = startTop + imgHeight + 5
                        End If
                    End With
                    picCount = picCount + 1
                End If
                On Error GoTo 0
                
                If picCount >= 4 Then Exit For
            End If
        Next shp
    End If
End Function
