import os
import shutil
import pandas as pd
import win32com.client as win32
from pptx import Presentation
from pptx.enum.shapes import MSO_SHAPE_TYPE

# ================= SOZLAMALAR =================
BASE_DIR = r"C:\ShaxzodOtchet\Automatization"
DONOR_PATH = os.path.join(BASE_DIR, "JAMI.pptx")
SHABLON_PATH = os.path.join(BASE_DIR, "PASPORT2.pptx")
EXCEL_PATH = os.path.join(BASE_DIR, "table.xlsx")
TEMP_IMG_DIR = os.path.join(BASE_DIR, "TEMP_IMAGES")

# Rasm o'lchamlari
IMG_W = 255
IMG_H = 194.5
START_L = 360
START_T = 80

# ================= 1. RASMLARNI EXCEL BO'YICHA QIDIRISH =================
def extract_images_targeted():
    print("1. Exceldagi VIN kodlar bo'yicha rasmlar qidirilmoqda...")
    
    # 1. Exceldan VIN kodlarni o'qib olamiz
    try:
        # Header=0 (1-qator), K ustun (11-ustun) VIN deb hisoblaymiz
        df = pd.read_excel(EXCEL_PATH, header=0, usecols="A:K", dtype=str)
        target_vins = []
        
        # VIN kodlarni tozalab ro'yxatga olamiz
        for val in df.iloc[:, 10]: # 10-indeks = K ustun
            if pd.notna(val):
                clean_vin = str(val).replace(" ", "").strip()
                if len(clean_vin) > 5:
                    target_vins.append(clean_vin)
        
        target_vins = list(set(target_vins)) # Takroriy kodlarni olib tashlaymiz
        print(f"   Jami {len(target_vins)} ta unikal VIN kod qidirilmoqda...")
        
    except Exception as e:
        print(f"Excelni o'qishda xatolik: {e}")
        return

    # Papkani tozalash
    if os.path.exists(TEMP_IMG_DIR):
        shutil.rmtree(TEMP_IMG_DIR)
    os.makedirs(TEMP_IMG_DIR)

    # 2. Donor faylni ochib qidiramiz
    prs = Presentation(DONOR_PATH)
    found_count = 0
    
    for slide in prs.slides:
        # Slayddagi barcha matnlarni bitta string qilamiz (qidirish oson bo'lishi uchun)
        slide_text_content = ""
        for shape in slide.shapes:
            if shape.has_text_frame:
                slide_text_content += shape.text_frame.text.replace(" ", "").upper()
            if shape.has_table:
                for row in shape.table.rows:
                    for cell in row.cells:
                        slide_text_content += cell.text_frame.text.replace(" ", "").upper()
        
        # 3. Bizning VIN kodlar shu slaydda bormi?
        matched_vin = None
        for vin in target_vins:
            # VIN slide ichida bormi?
            if vin.upper() in slide_text_content:
                matched_vin = vin
                break
        
        # 4. Agar topilsa, rasmlarni shu VIN papkasiga saqlaymiz
        if matched_vin:
            save_path = os.path.join(TEMP_IMG_DIR, matched_vin)
            if not os.path.exists(save_path):
                os.makedirs(save_path)
            
            img_count = 0
            
            # Ichki funksiya: Rasm saqlash
            def save_img(shp):
                nonlocal img_count
                try:
                    if shp.shape_type == MSO_SHAPE_TYPE.PICTURE:
                        with open(os.path.join(save_path, f"{img_count}.jpg"), "wb") as f:
                            f.write(shp.image.blob)
                        img_count += 1
                    elif shp.shape_type == MSO_SHAPE_TYPE.PLACEHOLDER and hasattr(shp, "image"):
                        with open(os.path.join(save_path, f"{img_count}.jpg"), "wb") as f:
                            f.write(shp.image.blob)
                        img_count += 1
                    elif shp.shape_type == MSO_SHAPE_TYPE.GROUP:
                        for sub in shp.shapes: save_img(sub)
                except: pass

            for shape in slide.shapes:
                save_img(shape)
            
            if img_count > 0:
                # print(f"   Topildi: {matched_vin} ({img_count} rasm)")
                found_count += 1

    print(f"   Bajarildi! {found_count} ta VIN kod uchun rasmlar topildi.")

# ================= 2. PASPORT YARATISH =================
def create_passports():
    print("2. Pasportlar yaratilmoqda...")
    
    try:
        # Excelni o'qish (Faqat kerakli ustunlar)
        df = pd.read_excel(EXCEL_PATH, header=0, usecols="A:K", dtype=str)
    except Exception as e:
        print(f"Xatolik: {e}")
        return

    ppt_app = win32.Dispatch("PowerPoint.Application")
    ppt_app.Visible = True
    pres = ppt_app.Presentations.Open(SHABLON_PATH)
    
    for index, row in df.iterrows():
        try:
            # Slayd nusxalash
            pres.Slides(1).Duplicate()
            slide = pres.Slides(2)
            
            # Ma'lumotlarni olish
            def get_s(i):
                try:
                    val = str(row.iloc[i])
                    if val.lower() in ['nan', 'nat', 'none']: return ""
                    return val.strip()
                except: return ""

            vals = [get_s(i) for i in range(11)] # 0 dan 10 gacha (A-K)
            val_vin = vals[10].replace(" ", "")  # K ustun (VIN)
            val_tavsif = vals[4]                 # E ustun (TAVSIF)

            # Jadval va Matnlarni almashtirish
            for shp in slide.Shapes:
                # Jadval
                if shp.HasTable:
                    tbl = shp.Table
                    try:
                        for r in range(1, 11): # 1 dan 10 gacha qatorlar
                            # E ustun (index 4) jadvalning 5-qatoriga tushadi
                            tbl.Cell(r, 2).Shape.TextFrame.TextRange.Text = vals[r-1]
                    except: pass
                
                # Sarlavhadagi {TAVSIF}
                if shp.HasTextFrame:
                    if shp.TextFrame.HasText:
                        txt = shp.TextFrame.TextRange
                        if "{TAVSIF}" in txt.Text: txt.Replace("{TAVSIF}", val_tavsif)
                        if "{TASNIF}" in txt.Text: txt.Replace("{TASNIF}", val_tavsif)

            # --- RASMLARNI QO'YISH ---
            if val_vin:
                img_folder = os.path.join(TEMP_IMG_DIR, val_vin)
                
                if os.path.exists(img_folder):
                    images = sorted(os.listdir(img_folder))
                    if images:
                        count = 0
                        for img_name in images:
                            if count >= 4: break
                            fpath = os.path.join(img_folder, img_name)
                            
                            try:
                                pic = slide.Shapes.AddPicture(fpath, False, True, 0, 0, IMG_W, IMG_H)
                                pic.LockAspectRatio = 0
                                
                                # 2x2 joylashuv
                                pic.Left = START_L if count % 2 == 0 else START_L + IMG_W + 5
                                pic.Top = START_T if count < 2 else START_T + IMG_H + 5
                                
                                # Ramka
                                pic.Line.Visible = -1
                                pic.Line.ForeColor.RGB = 0
                                pic.Line.Weight = 0.5
                                
                                count += 1
                            except: pass
                    else:
                        print(f"DIQQAT: {val_vin} papkasi bo'sh (rasm olinmagan).")
                else:
                    # Papka yo'q degani - Donor fayldan bu VIN topilmadi
                    pass

            slide.MoveTo(toPos=pres.Slides.Count)
            
        except Exception as e:
            print(f"Qator {index} da xatolik: {e}")

    print("JARAYON TUGADI!")

if __name__ == "__main__":
    extract_images_targeted()
    create_passports()
