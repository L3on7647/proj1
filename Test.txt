' --- BU QISM ENG TEPADA TURISHI SHART ---
#If VBA7 Then
    Private Declare PtrSafe Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
#Else
    Private Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
#End If
' -----------------------------------------

Sub PasportBezProbelRasmli()
    Dim pptApp As Object
    Dim targetPres As Object ' Shablon
    Dim sourcePres As Object ' Donor (Rasmlar bazasi)
    Dim pptSlide As Object
    Dim excelSheet As Worksheet
    Dim lastRow As Long, i As Long
    Dim targetPath As String
    Dim sourcePath As String
    Dim shp As Object, tbl As Object
    Dim vinCode As String
    
    ' ================= SOZLAMALAR =================
    
    ' 1. Pasport SHABLON fayli manzili:
    targetPath = "C:\Users\User\Desktop\Паспорт шаблон (002) (002).pptx"
    
    ' 2. Rasmlar va VIN kodlar bor "DONOR" fayl manzili:
    sourcePath = "C:\Users\User\Desktop\RASMLAR_BAZASI.pptx" 
    
    ' 3. Excel varaq nomi:
    Set excelSheet = ThisWorkbook.Sheets("TABLE")
    
    ' ==============================================

    On Error Resume Next
    Set pptApp = GetObject(, "PowerPoint.Application")
    If Err.Number <> 0 Then Set pptApp = CreateObject("PowerPoint.Application")
    On Error GoTo 0
    pptApp.Visible = True
    
    ' Fayllarni ochamiz
    Set targetPres = pptApp.Presentations.Open(targetPath)
    Set sourcePres = pptApp.Presentations.Open(sourcePath)
    
    lastRow = excelSheet.Cells(excelSheet.Rows.Count, 1).End(xlUp).Row

    ' --- SIKL ---
    For i = 2 To lastRow
        
        DoEvents: Sleep 100
        
        ' 1. Shablondan nusxa olamiz
        targetPres.Slides(1).Duplicate
        Set pptSlide = targetPres.Slides(2)
        
        ' 2. Jadvalni to'ldirish
        For Each shp In pptSlide.Shapes
            If shp.HasTable Then
                Set tbl = shp.Table
                tbl.Cell(1, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 1).Value
                tbl.Cell(2, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 2).Value
                tbl.Cell(3, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 3).Value
                tbl.Cell(4, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 4).Value
                tbl.Cell(5, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 5).Value
                tbl.Cell(6, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 6).Value
                tbl.Cell(7, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 7).Value
                tbl.Cell(8, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 8).Value
                tbl.Cell(9, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 9).Value
                tbl.Cell(10, 2).Shape.TextFrame.TextRange.Text = excelSheet.Cells(i, 10).Value
            End If
        Next shp
        
        ' 3. VIN kodni olish va PROBELLARDAN TOZALASH
        ' Replace(..., " ", "") hamma bo'sh joylarni olib tashlaydi
        vinCode = Replace(Trim(excelSheet.Cells(i, 11).Value), " ", "")
        
        ' 4. Rasmlarni qidirish
        If Len(vinCode) > 3 Then
            Call RasmlarniTopVaJoyla(sourcePres, pptSlide, vinCode)
        End If
        
        ' 5. Slaydni oxiriga o'tkazish
        pptSlide.MoveTo toPos:=targetPres.Slides.Count
        
    Next i

    MsgBox "Tayyor! Rasmlar joylandi.", vbInformation
End Sub

' --- QIDIRISH VA JOYLASH FUNKSIYASI ---
Sub RasmlarniTopVaJoyla(sourcePres As Object, targetSlide As Object, cleanVin As String)
    Dim sld As Object
    Dim shp As Object
    Dim foundSlide As Object
    Dim picCount As Integer
    Dim newPic As Object
    Dim slideText As String
    
    ' O'lchamlar (Pointlarda): 1 sm = 28.35 point
    Dim imgWidth As Double: imgWidth = 255     ' 9 sm
    Dim imgHeight As Double: imgHeight = 194.5 ' 6.86 sm
    
    ' Rasmlar boshlanish joyi (Slaydning o'ng tomoni)
    Dim startLeft As Double: startLeft = 360 
    Dim startTop As Double: startTop = 80 
    
    Set foundSlide = Nothing
    
    ' 1. HAR BIR SLAYDNI QIDIRIB CHIQAMIZ
    For Each sld In sourcePres.Slides
        For Each shp In sld.Shapes
            ' Agar bu Text Box bo'lsa
            If shp.HasTextFrame Then
                If shp.TextFrame.HasText Then
                    ' Slayddagi matnni olamiz va PROBELLARNI OLIB TASHLAYMIZ
                    slideText = Replace(shp.TextFrame.TextRange.Text, " ", "")
                    ' Katta-kichik harfni bir xil qilib qidiramiz
                    If InStr(1, slideText, cleanVin, vbTextCompare) > 0 Then
                        Set foundSlide = sld
                        Exit For
                    End If
                End If
            End If
            ' Agar VIN jadval ichida yozilgan bo'lsa (Qo'shimcha tekshiruv)
            If shp.HasTable Then
                Dim r As Long, c As Long
                For r = 1 To shp.Table.Rows.Count
                    For c = 1 To shp.Table.Columns.Count
                         If shp.Table.Cell(r, c).Shape.TextFrame.HasText Then
                            slideText = Replace(shp.Table.Cell(r, c).Shape.TextFrame.TextRange.Text, " ", "")
                            If InStr(1, slideText, cleanVin, vbTextCompare) > 0 Then
                                Set foundSlide = sld
                                Exit For
                            End If
                         End If
                    Next c
                    If Not foundSlide Is Nothing Then Exit For
                Next r
            End If
        Next shp
        If Not foundSlide Is Nothing Then Exit For
    Next sld
    
    ' 2. AGAR SLAYD TOPILSA, RASMLARNI KO'CHIRAMIZ
    If Not foundSlide Is Nothing Then
        picCount = 0
        For Each shp In foundSlide.Shapes
            ' Faqat rasmlarni olamiz (Type 13=Picture, 1=AutoShape(ba'zan rasm bo'ladi))
            ' Type 7 (Embedded OLE Object) ham bo'lishi mumkin
            If shp.Type = 13 Or shp.Type = 1 Or shp.Type = 7 Then
                
                shp.Copy
                DoEvents
                Sleep 300 ' Buferga tushishini kutish
                
                targetSlide.Shapes.Paste
                DoEvents
                
                ' Oxirgi tashlangan rasmni ushlab olamiz
                Set newPic = targetSlide.Shapes(targetSlide.Shapes.Count)
                
                ' --- 2x2 FORMATDA JOYLASH ---
                With newPic
                    .LockAspectRatio = msoFalse
                    .Width = imgWidth
                    .Height = imgHeight
                    
                    ' JOYLASHTIRISH MATEMATIKASI
                    ' 1-rasm (0): Left=Start, Top=Start
                    ' 2-rasm (1): Left=Start+Width, Top=Start
                    ' 3-rasm (2): Left=Start, Top=Start+Height
                    ' 4-rasm (3): Left=Start+Width, Top=Start+Height
                    
                    If (picCount Mod 2) = 0 Then
                        .Left = startLeft
                    Else
                        .Left = startLeft + imgWidth + 5
                    End If
                    
                    If picCount < 2 Then
                        .Top = startTop
                    Else
                        .Top = startTop + imgHeight + 5
                    End If
                    
                    ' Ramka qo'shish (Chiroyli ko'rinish uchun)
                    .Line.Visible = msoTrue
                    .Line.Weight = 0.5
                    .Line.ForeColor.RGB = RGB(0, 0, 0)
                End With
                
                picCount = picCount + 1
                If picCount >= 4 Then Exit For ' Maksimum 4 ta rasm
            End If
        Next shp
    End If
End Sub
